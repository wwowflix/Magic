import sys
if hasattr(sys.stdout, "reconfigure"):
    sys.stdout.reconfigure(encoding="utf-8")

import requests
import json
import pandas as pd
from datetime import datetime

# <<< STEP 1 — Load Cookies from JSON file >>>
cookies_path = r"D:\MAGIC\data\tiktok_cookies.json"

# Load your cookies file you saved earlier
with open(cookies_path, "r", encoding="utf-8-sig") as f:
    cookies_list = json.load(f)

cookies_dict = {cookie["name"]: cookie["value"] for cookie in cookies_list}

# <<< STEP 2 — API URL >>>

# Replace this with the exact URL you want to scrape
api_url = "https://www.tiktok.com/api/preload/item_list/?WebIdLastTime=1752343229&aid=1988&app_language=en-GB&app_name=tiktok_web&browser_language=en-GB&browser_name=Mozilla&browser_online=true&browser_platform=Win32&browser_version=5.0%20%28Windows%20NT%2010.0%3B%20Win64%3B%20x64%29%20AppleWebKit%2F537.36%20%28KHTML%2C%20like%20Gecko%29%20Chrome%2F138.0.0.0%20Safari%2F537.36&channel=tiktok_web&clientABVersions=70508271%2C72437276%2C73485603%2C73547759%2C73563784%2C73711489%2C73720541%2C73810951%2C73814855%2C73866686%2C73944034%2C73969557%2C73990103%2C74048200%2C74116274%2C74129613%2C74134587%2C74148344%2C74169178%2C74195789%2C74213193%2C74214201%2C74220104%2C70405643%2C70772958%2C71057832%2C71200802%2C71381811%2C71516509%2C71803300%2C71962127%2C72360691%2C72361743%2C72408100%2C72854054%2C72892778%2C73171280%2C73208420%2C73989921&cookie_enabled=true&count=3&coverFormat=2&data_collection_enabled=true&device_id=7526256823068083726&device_platform=web_pc&focus_state=false&from_page=hashtag&history_len=4&isNonPersonalized=false&is_fullscreen=false&is_page_visible=true&language=en&odinId=7526256839685866510&os=windows&priority_region=US&referer=&region=US&screen_height=1080&screen_width=1920&tz_name=Asia%2FCalcutta&user_is_login=true&verifyFp=verify_md0k4v5x_aq3O6gg9_mwrv_4VlF_8Hgm_UcCZ3LcRZnSX&vv_count_fyp=0&webcast_language=en-GB&msToken=n-zLSDtr2h-m2qwCnjK2CwvAtCf68bbvw441B_cszE3kTfMpJCr7lYc4Y8MA-0fBx1mhM3WkbzIYlkqsYaOX_B85n45yPLZwEP-q8XChkZaXhNwy6F9Yv6317T3xjMMhlewDkjsAMExBzw==&X-Bogus=DFSzswVYM20ANtgECS2y6WhPmkv/&X-Gnarly=Ma1wQbm5YqyWke1JDZnmcsbPTtEKuIf/1ku6nO-WcN9mflJX9KiMOYgbIrYN6yjcNaUOQGBkUX94p-j318u-6eJDmizPxHNaE6mZqkAsk4/1F4c58hJ3ziiimuZvwI9OUVgv9HJ/CJf6KRtGojgy3gAQmTRKSEBGz-cR6i2TnRCjbwJ52AfCBbWeYPKcTfQyGbqL3Im9erczyICuF/VIEITCWhnsfeHghHyrFTh7nIQYIel2H4YYe0kjzDbS3GSEON2UvN3VV1GSriCHMHCLV-yPKiTKCrlhb--fGyXkmWzS"

headers = {
    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/138.0.0.0 Safari/537.36",
    "Accept": "application/json",
    "Referer": "https://www.tiktok.com/",
}

# <<< STEP 3 — Send Request >>>
response = requests.get(api_url, headers=headers, cookies=cookies_dict)

print("STATUS CODE:", response.status_code)
print("RESPONSE TEXT:", response.text[:500])

if response.status_code == 200:
    if response.text.strip():
        data = response.json()
    else:
        print("❌ Response body is empty. TikTok returned nothing.")
        exit()
else:
    print("❌ TikTok returned HTTP error:", response.status_code)
    exit()

if response.status_code == 200:
    data = response.json()

    rows = []

    for item in data.get("itemList", []):
        desc = item.get("desc", "")
        author = item.get("author", {}).get("uniqueId", "")
        views = item.get("stats", {}).get("playCount", 0)
        likes = item.get("stats", {}).get("diggCount", 0)

        rows.append({
            "date": datetime.now().strftime("%Y-%m-%d"),
            "keyword": desc,
            "author": author,
            "views": views,
            "likes": likes,
            "platform": "TikTok"
        })

    df = pd.DataFrame(rows)

    if not df.empty:
        csv_path = r"D:\MAGIC\data\tiktok_trending.csv"
        df.to_csv(csv_path, index=False, encoding="utf-8-sig")
        print("✅ Data saved to:", csv_path)
        print(df.head())
    else:
        print("❌ No videos found in API response.")
else:
    print("❌ Request failed with status:", response.status_code)







# Cleanup Chrome driver handle to avoid WinError 6
try:
    driver.quit()
except:
    pass








