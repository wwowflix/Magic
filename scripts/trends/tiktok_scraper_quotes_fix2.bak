#!/usr/bin/env python3
"""
TikTok scraper template.
  1) Inspect the TikTok page for a reliable CSS selector.
  2) Fill in DESC_SELECTOR below.
  3) Run `python tiktok_scraper.py` to test.
"""

import time, os
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.common.exceptions import NoSuchElementException
from tenacity import retry, stop_after_attempt, wait_exponential

# TODO: replace with the CSS selector you copy from Chrome DevTools
DESC_SELECTOR = 'p[data-e2e='video-desc']'

@retry(stop=stop_after_attempt(3), wait=wait_exponential(multiplier=1, max=5), reraise=True)
def fetch_descriptions(driver, url):
    driver.get(url); time.sleep(4)
    for _ in range(8):
        driver.execute_script("window.scrollBy(0, document.body.scrollHeight);")
        time.sleep(4)
    elems = driver.find_elements(By.CSS_SELECTOR, DESC_SELECTOR)
    if not elems:
        print(f"[WARN] No elements for selector {DESC_SELECTOR}")
        return []
    return [e.text for e in elems]

def main():
    url = os.getenv("TIKTOK_URL", "https://www.tiktok.com/tag/yourhashtag")
    options = webdriver.ChromeOptions(); options.add_argument("--headless")
    driver = webdriver.Chrome(options=options)
    try:
        items = fetch_descriptions(driver, url)
        os.makedirs("outputs", exist_ok=True)
        with open("outputs/tiktok_scrape.csv", "w", encoding="utf-8") as f:
            f.write("description\n")
            for it in items:
                f.write(f"\"{it.replace('\"','\"\"')}\"\n")
        print(f"[OK] Scraped {len(items)} descriptions")
    except Exception as e:
        print(f"[ERROR] {type(e).__name__}: {e}")
    finally:
        driver.quit()

if __name__ == "__main__":
    main()
