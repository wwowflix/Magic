import sys
if hasattr(sys.stdout, "reconfigure"):
    sys.stdout.reconfigure(encoding="utf-8")

import time
import json
import pandas as pd
import undetected_chromedriver as uc
from selenium.webdriver.common.by import By
from datetime import datetime
import os

# Load cookies
cookies_path = r'D:\MAGIC\data\tiktok_cookies.json'

with open(cookies_path, "r", encoding="utf-8-sig") as f:
    cookies = json.load(f)

# Start undetected Chrome
options = uc.ChromeOptions()
options.add_argument('--no-sandbox')
options.add_argument('--disable-dev-shm-usage')
options.add_argument('--disable-blink-features=AutomationControlled')

driver = uc.Chrome(options=options)

# Go to TikTok main page
driver.get('https://www.tiktok.com/')

# Add each cookie
for cookie in cookies:
    cookie_dict = {
        'name': cookie['name'],
        'value': cookie['value'],
        'domain': '.tiktok.com',
        'path': '/',
        'secure': True,
        'httpOnly': False
    }
    driver.add_cookie(cookie_dict)

# Visit trending page
driver.get('https://www.tiktok.com/tag/trending')

time.sleep(20)  # Let page load fully

# Scroll the page gently
for i in range(20):
    driver.execute_script("window.scrollBy(0, 1000);")
    time.sleep(2)

# Extract titles
titles = []
elements = driver.find_elements(By.XPATH, "//h3")
for el in elements:
    text = el.text.strip()
    if text:
        print("FOUND:", text)
        titles.append(text)

driver.quit()

# Save to CSV
records = []
for title in titles:
    records.append({
        "date": datetime.today().strftime("%Y-%m-%d"),
        "keyword": title,
        "platform": "TikTok",
        "metric": 1
    })

df = pd.DataFrame(records)

# Save CSV
output_path = r'D:\MAGIC\data\tiktok_trending.csv'
df.to_csv(output_path, index=False, encoding='utf-8-sig')

print(f"✅ TikTok trending data saved to {output_path}")
