# full_pipeline.ps1 — now forces UTF-8 output for non-ASCII
Write-Host "STEP 1.5 – Standardizing CSV schemas…"
python .\standardize_columns.py 2>&1 | Tee-Object -FilePath \ -Append

Write-Host "STEP 1.6 – Deduplicating database records…"
python .\deduplicate_records.py 2>&1 | Tee-Object -FilePath \ -Append

Write-Host "STEP 1.7 – Validation checks…"
python .\validation_checks.py   2>&1 | Tee-Object -FilePath \ -Append

# Ensure PowerShell uses UTF-8 for console output
[Console]::OutputEncoding = [System.Text.Encoding]::UTF8
$OutputEncoding = [System.Text.Encoding]::UTF8

Set-Location "D:\MAGIC\scripts"

# Start log
$log = "full_pipeline.log"
"`n===== Pipeline run at $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss') =====`n" | Out-File $log

# 1) Scrape all platforms
Write-Host "STEP 1 - Scraping..." | Tee-Object -FilePath $log -Append
Write-Host "STEP 1.5 – Standardizing CSV schemas…"
Write-Host "STEP 1.5 – Standardizing CSV schemas…"
python .\standardize_columns.py 2>&1 | Tee-Object -FilePath $log -Append

Write-Host "STEP 1.6 – Deduplicating database records…"
python .\deduplicate_records.py 2>&1 | Tee-Object -FilePath $log -Append

Write-Host "STEP 1.7 – Validation checks…"
python .\validation_checks.py 2>&1 | Tee-Object -FilePath $log -Append
python .\standardize_columns.py 2>&1 | Tee-Object -FilePath $log -Append

Write-Host "STEP 1.6 – Deduplicating database records…"
python .\deduplicate_records.py 2>&1 | Tee-Object -FilePath $log -Append

Write-Host "STEP 1.7 – Validation checks…"
python .\validation_checks.py 2>&1 | Tee-Object -FilePath $log -Append
python .\trends_scraper.py --source google 2>&1 | Tee-Object -FilePath $log -Append
python .\trends_scraper.py --source reddit 2>&1 | Tee-Object -FilePath $log -Append
python .\trends_scraper.py --source youtube 2>&1 | Tee-Object -FilePath $log -Append
python .\trends_scraper.py --source tiktok 2>&1 | Tee-Object -FilePath $log -Append

# 2) Data Quality
Write-Host "STEP 2 - Data Quality Checks..." | Tee-Object -FilePath $log -Append
.\data_quality.ps1 2>&1 | Tee-Object -FilePath $log -Append

# 3) Ingest into SQLite
Write-Host "STEP 3 - Ingesting into SQLite..." | Tee-Object -FilePath $log -Append
python .\ingest_csvs_to_db.py 2>&1 | Tee-Object -FilePath $log -Append

# 4) Tests
Write-Host "STEP 4 - Testing..." | Tee-Object -FilePath $log -Append
.\run_tests.ps1 2>&1 | Tee-Object -FilePath $log -Append

# 5) Dashboard
Write-Host "STEP 5 - Launching dashboard..." | Tee-Object -FilePath $log -Append
Start-Process -FilePath "streamlit" -ArgumentList "run .\dashboard.py"
"Dashboard launched in background." | Tee-Object -FilePath $log -Append

# 6) Notification
Write-Host "STEP 6 - Sending email summary..." | Tee-Object -FilePath $log -Append
.\notify_summary.ps1 2>&1 | Tee-Object -FilePath $log -Append

Write-Host "✅ Full pipeline complete. See full_pipeline.log for details."
